
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç WebSocket Deep Diagnostic</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
        }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        .connecting { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        .log {
            background: #fff;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .metric {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .error { color: #dc3545; }
        .success { color: #28a745; }
    </style>
</head>
<body>
    <h1>üîç WebSocket Deep Diagnostic Tool</h1>
    
    <div class="grid">
        <div class="metric">
            <div>–°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>
            <div id="connectionStatus" class="metric-value">‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</div>
        </div>
        <div class="metric">
            <div>–ü–æ–ø—ã—Ç–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>
            <div id="connectionAttempts" class="metric-value">0</div>
        </div>
        <div class="metric">
            <div>–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π</div>
            <div id="messagesReceived" class="metric-value">0</div>
        </div>
        <div class="metric">
            <div>–í—Ä–µ–º—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>
            <div id="connectionTime" class="metric-value">-</div>
        </div>
    </div>

    <div>
        <button id="connectBtn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <button id="disconnectBtn" disabled>‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
        <button id="pingBtn" disabled>üèì Ping Test</button>
        <button id="clearLogBtn">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
        <button id="testMultipleBtn">üîÑ –¢–µ—Å—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π</button>
    </div>

    <div id="urlInfo" class="info">
        üåê WebSocket URL: <span id="wsUrl">-</span>
    </div>

    <h3>üìã –î–µ—Ç–∞–ª—å–Ω—ã–π –ª–æ–≥:</h3>
    <div id="logs" class="log">
–û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥...
    </div>

    <script>
        let ws = null;
        let connectionAttempts = 0;
        let messagesReceived = 0;
        let connectionStartTime = null;
        
        const elements = {
            status: document.getElementById('connectionStatus'),
            attempts: document.getElementById('connectionAttempts'),
            messages: document.getElementById('messagesReceived'),
            time: document.getElementById('connectionTime'),
            logs: document.getElementById('logs'),
            connectBtn: document.getElementById('connectBtn'),
            disconnectBtn: document.getElementById('disconnectBtn'),
            pingBtn: document.getElementById('pingBtn'),
            clearLogBtn: document.getElementById('clearLogBtn'),
            testMultipleBtn: document.getElementById('testMultipleBtn'),
            wsUrl: document.getElementById('wsUrl')
        };
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            elements.logs.textContent += `[${timestamp}] ${emoji} ${message}\n`;
            elements.logs.scrollTop = elements.logs.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateMetrics() {
            elements.attempts.textContent = connectionAttempts;
            elements.messages.textContent = messagesReceived;
            
            if (connectionStartTime && ws && ws.readyState === WebSocket.OPEN) {
                const duration = ((Date.now() - connectionStartTime) / 1000).toFixed(1);
                elements.time.textContent = `${duration}s`;
            }
        }
        
        function getWebSocketUrl() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            
            log(`–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ URL: protocol=${protocol}, host=${host}`);
            
            // –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è URL (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è)
            const isReplit = host.includes('replit.dev') || host.includes('repl.co') || host.includes('replit.app');
            const isDev = host.includes('localhost') || host.includes('127.0.0.1') || host.includes(':5006') || host.includes(':5173');
            
            let wsUrl;
            
            if (isReplit) {
                wsUrl = `${protocol}//${host}/api/ws`;
                log(`Replit –æ–∫—Ä—É–∂–µ–Ω–∏–µ: ${wsUrl}`);
            } else if (isDev) {
                const devProtocol = 'ws:';
                if (host.includes(':')) {
                    const baseHost = host.split(':')[0];
                    wsUrl = `${devProtocol}//${baseHost}:5000/api/ws`;
                } else {
                    wsUrl = `${devProtocol}//${host}:5000/api/ws`;
                }
                log(`Dev –æ–∫—Ä—É–∂–µ–Ω–∏–µ: ${wsUrl}`);
            } else {
                wsUrl = `${protocol}//${host}/api/ws`;
                log(`Production –æ–∫—Ä—É–∂–µ–Ω–∏–µ: ${wsUrl}`);
            }
            
            elements.wsUrl.textContent = wsUrl;
            return wsUrl;
        }
        
        function updateStatus(status) {
            elements.status.textContent = status;
            elements.status.className = 'metric-value ' + 
                (status.includes('–ü–æ–¥–∫–ª—é—á–µ–Ω') ? 'success' : 
                 status.includes('–û—à–∏–±–∫–∞') ? 'error' : '');
        }
        
        function connect() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'warning');
                return;
            }
            
            connectionAttempts++;
            connectionStartTime = Date.now();
            updateMetrics();
            
            const wsUrl = getWebSocketUrl();
            log(`–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è #${connectionAttempts} –∫: ${wsUrl}`);
            updateStatus('üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
            
            try {
                ws = new WebSocket(wsUrl);
                log(`WebSocket –æ–±—ä–µ–∫—Ç —Å–æ–∑–¥–∞–Ω, readyState: ${ws.readyState}`);
                
                ws.onopen = function(event) {
                    log('üéâ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                    log(`ReadyState: ${ws.readyState} (OPEN)`);
                    updateStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω');
                    
                    elements.connectBtn.disabled = true;
                    elements.disconnectBtn.disabled = false;
                    elements.pingBtn.disabled = false;
                    
                    updateMetrics();
                };
                
                ws.onmessage = function(event) {
                    messagesReceived++;
                    updateMetrics();
                    
                    try {
                        const data = JSON.parse(event.data);
                        log(`üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: ${data.type} - ${data.message || JSON.stringify(data).substring(0, 100)}`, 'success');
                    } catch (e) {
                        log(`üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ (raw): ${event.data.substring(0, 200)}`, 'info');
                    }
                };
                
                ws.onclose = function(event) {
                    log(`üîå WebSocket –∑–∞–∫—Ä—ã—Ç - –∫–æ–¥: ${event.code}, –ø—Ä–∏—á–∏–Ω–∞: "${event.reason}"`, 'warning');
                    log(`–ë—ã–ª–æ —á–∏—Å—Ç–æ –∑–∞–∫—Ä—ã—Ç–æ: ${event.wasClean}`);
                    updateStatus('‚ùå –û—Ç–∫–ª—é—á–µ–Ω');
                    
                    elements.connectBtn.disabled = false;
                    elements.disconnectBtn.disabled = true;
                    elements.pingBtn.disabled = true;
                    
                    updateMetrics();
                };
                
                ws.onerror = function(error) {
                    log(`üö® WebSocket –æ—à–∏–±–∫–∞: ${error.type || 'Unknown error'}`, 'error');
                    log(`ReadyState –ø—Ä–∏ –æ—à–∏–±–∫–µ: ${ws ? ws.readyState : 'undefined'}`);
                    log(`URL –ø—Ä–∏ –æ—à–∏–±–∫–µ: ${wsUrl}`);
                    updateStatus('‚ùå –û—à–∏–±–∫–∞');
                };
                
            } catch (error) {
                log(`üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è WebSocket: ${error.message}`, 'error');
                updateStatus('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞');
            }
        }
        
        function disconnect() {
            if (ws) {
                log('üîå –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ...');
                ws.close(1000, 'Manual disconnect');
                ws = null;
            }
        }
        
        function sendPing() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('‚ùå WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω! –ù–µ–ª—å–∑—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å ping.', 'error');
                return;
            }
            
            const pingMessage = {
                type: 'ping',
                timestamp: Date.now(),
                testId: Math.random().toString(36).substr(2, 9)
            };
            
            try {
                ws.send(JSON.stringify(pingMessage));
                log(`üèì Ping –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: ${pingMessage.testId}`, 'info');
            } catch (error) {
                log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ ping: ${error.message}`, 'error');
            }
        }
        
        function testMultipleConnections() {
            log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Ç–µ—Å—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π...', 'info');
            
            for (let i = 1; i <= 3; i++) {
                setTimeout(() => {
                    log(`üîó –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ #${i}`, 'info');
                    const testWs = new WebSocket(getWebSocketUrl());
                    
                    testWs.onopen = () => {
                        log(`‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ #${i} —É—Å–ø–µ—à–Ω–æ`, 'success');
                        setTimeout(() => {
                            testWs.close(1000, `Test connection ${i} closing`);
                        }, 2000);
                    };
                    
                    testWs.onerror = (error) => {
                        log(`‚ùå –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ #${i} –æ—à–∏–±–∫–∞`, 'error');
                    };
                    
                    testWs.onclose = () => {
                        log(`üîå –¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ #${i} –∑–∞–∫—Ä—ã—Ç–æ`, 'info');
                    };
                }, i * 1000);
            }
        }
        
        function clearLog() {
            elements.logs.textContent = '–õ–æ–≥ –æ—á–∏—â–µ–Ω...\n';
        }
        
        // Event listeners
        elements.connectBtn.addEventListener('click', connect);
        elements.disconnectBtn.addEventListener('click', disconnect);
        elements.pingBtn.addEventListener('click', sendPing);
        elements.clearLogBtn.addEventListener('click', clearLog);
        elements.testMultipleBtn.addEventListener('click', testMultipleConnections);
        
        // Initialize
        log('üöÄ WebSocket Deep Diagnostic Tool –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ');
        log(`üåç –¢–µ–∫—É—â–∏–π URL: ${window.location.href}`);
        log(`üè† Host: ${window.location.host}`);
        log(`üîí Protocol: ${window.location.protocol}`);
        
        // Auto-detect and show URL
        getWebSocketUrl();
    </script>
</body>
</html>
